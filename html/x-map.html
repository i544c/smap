<link rel="import" href="bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="bower_components/google-map/google-map.html">
<link rel="import" href="bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="bower_components/iron-icons/iron-icons.html">
<link rel="import" href="bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="bower_components/paper-toast/paper-toast.html">
<link rel="import" href="bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="bower_components/paper-input/paper-input.html">
<link rel="import" href="bower_components/paper-input/paper-textarea.html">
<link rel="import" href="bower_components/paper-button/paper-button.html">
<link rel="import" href="bower_components/paper-spinner/paper-spinner.html">

<link rel="import" href="x-drawer.html">

<dom-module id="x-map">
  <template>
    <style>
    #drawerIcon {
      position: fixed;
      top: 10px;
      left: 10px;
      color: white;
    }
    #drawer {
      z-index: 1;
    }
    .center {
      @apply(--layout-horizontal);
      @apply(--layout-center-justified);
    }
    #smaruIcon {
      position: fixed;
      bottom: 0;
      width: 80px;
      height: 80px;
      margin-left: 45%;
      margin-left: -webkit-calc(50% - 40px);
      margin-left: calc(50% - 40px);
    }
    .blue {
      color: white;
      font-weight: bold;
      background-color: #29B6F6;
    }
    </style>

    <iron-ajax
      auto
      url="map-style.json"
      last-response="{{mapStyle}}"
    /></iron-ajax>
    <iron-ajax
      auto
      url="sample/markers.json"
      last-response="{{markers}}"
    /></iron-ajax>

    <google-map id="map"
      api-key=""
      styles="[[mapStyle]]"
      gesture-handling="greedy"
      disable-default-ui single-info-window />
      <template is="dom-repeat" items="[[markers]]">
        <google-map-marker
          latitude="[[item.position.lat]]"
          longitude="[[item.position.lng]]"
          animation="DROP" />
          <h3>[[item.name]]</h3>
          <p>[[item.message]]</p>
        </google-map-marker>
      </template>
    </google-map>

    <paper-icon-button id="drawerIcon" icon="menu" on-click="_toggleDrawer"></paper-icon-button>
    <app-drawer id="drawer">
      <x-drawer></x-drawer>
    </app-drawer>

    <paper-icon-button id="smaruIcon" src="smaru.svg" on-click="_toggleSmaru"></paper-icon-button>
    <paper-dialog id="smaruDialog" modal>
      <paper-input id="tag" label="タグ"></paper-input>
      <paper-textarea id="message" label="内容"></paper-textarea>
      <div class="center">
        <paper-button raised on-click="_toggleSmaru" disabled="[[sendingSmaru]]">閉じる</paper-button>
        <paper-button class="blue" raised on-click="_sendSmaru" disabled="[[sendingSmaru]]">すまる</paper-button>
        <paper-spinner active="[[sendingSmaru]]"></paper-spinner>
      </div>
    </paper-dialog>

    <paper-toast id="toast" text="Hello, world!"></paper-toast>
  </template>

  <script>
  Polymer({
    is: 'x-map',
    properties: {
      isGeo: {
        type: Boolean,
        value: true
      },
      sendingSmaru: {
        type: Boolean,
        value: false
      }
    },
    ready: function() {
      if(!navigator.geolocation) {
        this.$.toast.show({text: "お使いの端末では現在地を取得できません..."});
        this.isGeo = false;
      } else {
        this._getLocation().then((nowPosition) => {
          this.$.map.latitude = nowPosition.lat;
          this.$.map.longitude = nowPosition.lng;
        }).catch(function(error) {
          alert(error);
        });
      }
    },

    /**
    * 現在地を取得し、リストを返す
    * @return {List} 現在地
    */
    _getLocation: function() {
      return new Promise((resolve, reject) => {
        navigator.geolocation.getCurrentPosition((position) => {
          resolve({
            lat: position.coords.latitude,
            lng: position.coords.longitude
          });
        }, function() {
          reject("現在地取得に失敗しました...");
        });
      });
    },

    /**
    * drawerの開け閉め
    */
    _toggleDrawer: function() {
      this.$.drawer.toggle();
    },

    /**
    * すまるボタン
    */
    _toggleSmaru: function() {
      this.$.smaruDialog.toggle();
    },

    /**
    * すまる
    */
    _sendSmaru: function() {
      this.sendingSmaru = true;
      window.setTimeout(() => {
        this.sendingSmaru = false;
        this.$.smaruDialog.toggle();
        this.$.toast.show({text: "送信したつもり"});
        //inputの中身を消す
        this.$.tag.value = "";
        this.$.message.value = "";
      }, 5000);
    }
  });
  </script>
</dom-module>
